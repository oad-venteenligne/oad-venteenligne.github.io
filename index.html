<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Catalogue d'outils agricoles</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    /* Styles généraux du contenu */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f9f9f9;
    }
    
    .custom-content {
      background: linear-gradient(135deg, #f9f9f9, #e8f5e9);
      margin: 20px auto;
      padding: 20px;
      max-width: 1200px;
      position: relative;
    }

    /* Layout en deux colonnes pour les écrans larges */
    .layout {
      display: flex;
      gap: 20px;
    }
    
    .sidebar {
      flex: 0 0 300px; /* Largeur fixe pour la colonne des filtres */
    }
    
    .main-content {
      flex: 1;
    }

    /* Sur mobile, le layout passe en colonne (les filtres en haut) */
    @media (max-width: 768px) {
      .layout {
        flex-direction: column;
      }
    }

    /* Titre principal */
    h1 {
      margin-top: 20px;
      text-align: center;
      color: #2e7d32;
    }

    /* Conteneur des fiches en grille : 2 colonnes par défaut */
    #fiches-container {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      width: 100%;
      box-sizing: border-box;
    }
    
    /* Sur grand écran, 3 colonnes */
    @media (min-width: 1200px) {
      #fiches-container {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    
    /* Sur mobile, une seule colonne */
    @media (max-width: 768px) {
      #fiches-container {
        grid-template-columns: 1fr;
      }
    }

    /* Styles des fiches (cards) */
    .tool-card {
      display: flex;
      max-width: 550px;
      width: 100%;
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), 
                  box-shadow 0.3s ease;
      position: relative;
      animation: fadeIn 0.5s ease-out;
    }
    
    .tool-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
    }
    
    .tool-card:after {
      content: '';
      position: absolute;
      bottom: -8px;
      left: 5%;
      width: 90%;
      height: 10px;
      background: rgba(0, 0, 0, 0.05);
      filter: blur(10px);
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }
    
    .tool-card:hover:after {
      opacity: 1;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .card-left {
      padding: 16px;
      background-color: #f5f5f5;
      text-align: center;
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    
    .tool-logo {
      max-width: 100px;
      margin-bottom: 12px;
      transition: transform 0.3s ease;
    }
    
    .tool-card:hover .tool-logo {
      transform: scale(1.05);
    }
    
    .tool-category {
      background-color: #FFCC00;
      color: #333;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      text-transform: uppercase;
      font-weight: bold;
    }
    
    /* Zone d'affichage du nombre de filtres correspondants */
    .match-info {
      position: relative;
      background: linear-gradient(135deg, #f5f5f5, #e0e0e0);
      border-radius: 16px;
      padding: 3px 8px;
      font-size: 10px;
      font-weight: bold;
      color: #555;
      margin-top: 10px;
      text-align: center;
    }
    
    .card-right {
      flex: 2;
      padding: 20px;
      background: white;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    
    .highlight-box {
      background: #f9f9f9;
      padding: 12px;
      border-left: 4px solid #4caf50;
      border-radius: 8px;
      margin: 10px 0;
      font-size: 14px;
      color: #333;
    }
    
    .tool-title {
      font-size: 24px;
      color: #333;
      font-weight: bold;
      margin: 0;
    }
    
    .tool-description {
      font-size: 14px;
      color: #555;
      margin: 10px 0;
      line-height: 1.4;
    }
    
    .highlight-match {
      background-color: #FFEB3B;
      padding: 0 2px;
      border-radius: 2px;
    }
    
    .cta-button {
      background: #4caf50;
      color: white;
      padding: 8px 16px;
      font-size: 12px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      text-transform: uppercase;
      font-weight: bold;
      transition: background 0.3s ease, transform 0.2s ease;
      align-self: flex-start;
    }
    
    .cta-button:hover {
      background: #388e3c;
      transform: translateY(-2px);
    }

    /* Style pour les fiches ne correspondant pas aux filtres */
    .tool-card.unmatched {
      filter: grayscale(100%);
      opacity: 0.5;
    }
    
    /* Styles pour les filtres */
    #filters {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      margin: 20px 0;
    }
    
    .filter-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      padding: 10px;
      background: #f0f7f0;
      border-radius: 8px;
      margin-bottom: 5px;
      border-left: 4px solid #4caf50;
      transition: all 0.2s ease;
    }
    
    .filter-header:hover {
      background: #e0f0e0;
    }
    
    .filter-content {
      display: none;
      padding: 12px;
      border-left: 4px solid #e8e8e8;
      margin-left: 4px;
      animation: slideDown 0.3s ease;
    }
    
    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Style pour la barre de recherche */
    .search-container {
      margin-bottom: 20px;
    }
    
    #search-input {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ddd;
      font-size: 14px;
      transition: all 0.3s ease;
    }
    
    #search-input:focus {
      border-color: #4caf50;
      box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
      outline: none;
    }
    
    /* Style pour les checkbox et radio buttons */
    input[type="checkbox"], input[type="radio"] {
      margin-right: 8px;
      cursor: pointer;
      accent-color: #4caf50;
    }
    
    label {
      cursor: pointer;
      transition: opacity 0.2s;
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }
    
    label:hover {
      opacity: 0.8;
    }
    
    /* Style pour la carte de France cliquable */
    .department-map {
      width: 100%;
      margin-bottom: 15px;
    }
    
    #france-map {
      width: 100%;
      height: auto;
    }
    
    #france-map path {
      fill: #E8F5E9;
      stroke: #4caf50;
      stroke-width: 1px;
      cursor: pointer;
      transition: fill 0.2s ease;
    }
    
    #france-map path:hover {
      fill: #C8E6C9;
    }
    
    #france-map path.selected {
      fill: #4CAF50;
    }
    
    .selected-departments {
      font-size: 12px;
      margin-top: 10px;
      color: #666;
    }
    
    /* Indicateur de chargement */
    .loader {
      display: inline-block;
      width: 50px;
      height: 50px;
      border: 3px solid rgba(76,175,80,0.3);
      border-radius: 50%;
      border-top-color: #4caf50;
      animation: spin 1s ease-in-out infinite;
      margin: 50px auto;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .loading-container {
      text-align: center;
      padding: 50px 0;
    }
    
    /* Bouton d'export */
    .export-button {
      background: #4caf50;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      margin-bottom: 20px;
      font-weight: bold;
      display: flex;
      align-items: center;
      transition: all 0.2s ease;
    }
    
    .export-button:before {
      content: "⬇️";
      margin-right: 8px;
      font-size: 16px;
    }
    
    .export-button:hover {
      background: #388e3c;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    /* Compteur de résultats */
    #results-stats {
      margin-bottom: 15px;
      font-size: 14px;
      color: #666;
    }
    
    /* Mode sombre */
    .dark-mode-toggle {
      position: absolute;
      top: 10px;
      right: 10px;
      background: transparent;
      border: none;
      cursor: pointer;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.3s ease;
      z-index: 10;
    }
    
    .dark-mode-toggle:hover {
      background-color: rgba(0,0,0,0.1);
    }
    
    .dark-mode .dark-mode-toggle:hover {
      background-color: rgba(255,255,255,0.1);
    }
    
    .dark-mode {
      background: #121212;
    }
    
    .dark-mode .custom-content {
      background: linear-gradient(135deg, #1a1a1a, #2d2d2d);
      color: #e0e0e0;
    }
    
    .dark-mode #filters {
      background: #2d2d2d;
      color: #e0e0e0;
    }
    
    .dark-mode .tool-card {
      background: #2d2d2d;
    }
    
    .dark-mode .card-left {
      background: #1a1a1a;
    }
    
    .dark-mode .card-right {
      background: #2d2d2d;
      color: #e0e0e0;
    }
    
    .dark-mode .tool-title {
      color: #ffffff;
    }
    
    .dark-mode .tool-description {
      color: #bbbbbb;
    }
    
    .dark-mode .highlight-box {
      background: #383838;
      border-left: 4px solid #66bb6a;
    }
    
    .dark-mode .filter-header {
      background: #383838;
      color: #e0e0e0;
    }
    
    .dark-mode .filter-header:hover {
      background: #404040;
    }
    
    .dark-mode input[type="text"] {
      background: #383838;
      color: #e0e0e0;
      border-color: #555;
    }
    
    /* Gestion du layout sur mobile */
    @media (max-width: 576px) {
      .tool-card {
        flex-direction: column;
      }
      
      .card-left {
        padding: 20px 10px;
        width: 100%;
      }
      
      .card-right {
        padding: 15px;
      }
      
      .tool-title {
        font-size: 20px;
      }
      
      .export-button {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <div class="custom-content">
    <h1>Catalogue d'outils agricoles</h1>
    <button id="dark-mode-toggle" class="dark-mode-toggle" title="Basculer mode sombre/clair">🌙</button>
    
    <div class="layout">
      <!-- Colonne des filtres -->
      <div class="sidebar">
        <div id="filters">
          <!-- Barre de recherche -->
          <div class="search-container">
            <input type="text" id="search-input" class="form-control" placeholder="Rechercher un outil..." />
          </div>
          
          <!-- Filtre "Département" -->
          <div class="filter-header" data-target="filter-departments">
            <span>Région</span>
            <span>⬇️</span>
          </div>
          <div id="filter-departments" class="filter-content">
            <!-- Carte simplifiée de la France par régions -->
            <div class="department-map">
              <svg viewBox="0 0 600 600" id="france-map">
                <!-- Régions simplifiées de France -->
                <path id="region-idf" d="M300,200 L330,180 L360,200 L330,230 Z" data-name="Île-de-France" data-code="IDF" />
                <path id="region-hdf" d="M250,150 L300,150 L300,200 L250,200 Z" data-name="Hauts-de-France" data-code="HDF" />
                <path id="region-est" d="M380,200 L430,180 L430,230 L380,250 Z" data-name="Grand Est" data-code="EST" />
                <path id="region-bzh" d="M100,200 L150,180 L170,210 L120,230 Z" data-name="Bretagne" data-code="BZH" />
                <path id="region-pdl" d="M180,220 L230,200 L250,230 L200,250 Z" data-name="Pays de la Loire" data-code="PDL" />
                <path id="region-nor" d="M200,150 L250,150 L240,200 L190,190 Z" data-name="Normandie" data-code="NOR" />
                <path id="region-cvl" d="M250,230 L300,200 L330,230 L300,260 L270,260 Z" data-name="Centre-Val de Loire" data-code="CVL" />
                <path id="region-bfc" d="M330,230 L380,250 L360,300 L310,280 Z" data-name="Bourgogne-Franche-Comté" data-code="BFC" />
                <path id="region-ara" d="M310,280 L360,300 L350,370 L300,350 L270,310 Z" data-name="Auvergne-Rhône-Alpes" data-code="ARA" />
                <path id="region-occ" d="M200,350 L270,310 L300,350 L240,400 Z" data-name="Occitanie" data-code="OCC" />
                <path id="region-paca" d="M350,370 L400,350 L380,400 L330,410 Z" data-name="Provence-Alpes-Côte d'Azur" data-code="PACA" />
                <path id="region-na" d="M150,280 L270,310 L200,350 L150,320 Z" data-name="Nouvelle-Aquitaine" data-code="NA" />
                <path id="region-cor" d="M410,420 L430,400 L450,420 L430,440 Z" data-name="Corse" data-code="COR" />
              </svg>
            </div>
            <div class="selected-departments">
              <p>Régions sélectionnées: <span id="selected-dept-list">Aucune</span></p>
            </div>
          </div>
          
          <!-- Option de tri -->
          <div class="filter-header" data-target="filter-sort">
            <span>Trier par</span>
            <span>⬇️</span>
          </div>
          <div id="filter-sort" class="filter-content">
            <label><input type="radio" name="sort" value="alpha" class="filter-sort" checked> Ordre alphabétique</label>
            <label><input type="radio" name="sort" value="year" class="filter-sort"> Année de création</label>
            <label><input type="radio" name="sort" value="relevance" class="filter-sort"> Pertinence</label>
          </div>
          
          <!-- Filtre "Type de plateforme" -->
          <div class="filter-header" data-target="filter-platforms">
            <span>Type de plateforme</span>
            <span>⬇️</span>
          </div>
          <div id="filter-platforms" class="filter-content">
            <label><input type="checkbox" value="1" class="filter-platform"> Générateur de Boutique</label>
            <label><input type="checkbox" value="2" class="filter-platform"> Place de Marché</label>
            <label><input type="checkbox" value="3" class="filter-platform"> Outil de Gestion</label>
          </div>
          
          <!-- Filtre "Type d'acheteurs" -->
          <div class="filter-header" data-target="filter-clients">
            <span>Type d'acheteurs</span>
            <span>⬇️</span>
          </div>
          <div id="filter-clients" class="filter-content">
            <label><input type="checkbox" value="1" class="filter-client"> Consommateurs particuliers</label>
            <label><input type="checkbox" value="2" class="filter-client"> Restauration collective</label>
            <label><input type="checkbox" value="3" class="filter-client"> Restauration commerciale</label>
            <label><input type="checkbox" value="4" class="filter-client"> GMS</label>
            <label><input type="checkbox" value="5" class="filter-client"> Commerces de proximité</label>
            <label><input type="checkbox" value="6" class="filter-client"> Grossistes</label>
            <label><input type="checkbox" value="7" class="filter-client"> Transformateurs</label>
            <label><input type="checkbox" value="8" class="filter-client"> Producteurs</label>
          </div>
          
          <!-- Filtre "Coût de l'outil" -->
          <div class="filter-header" data-target="filter-cout">
            <span>Coût de l'outil</span>
            <span>⬇️</span>
          </div>
          <div id="filter-cout" class="filter-content">
            <label><input type="checkbox" value="1" class="filter-cout"> Totalement gratuit</label>
            <label><input type="checkbox" value="2" class="filter-cout"> Commission prélevée au producteur</label>
            <label><input type="checkbox" value="3" class="filter-cout"> Abonnement / droit d'entrée pour le producteur</label>
            <label><input type="checkbox" value="4" class="filter-cout"> Commission prélevée au consommateur</label>
            <label><input type="checkbox" value="5" class="filter-cout"> Abonnement / droit d'entrée pour le consommateur</label>
          </div>
        </div>
      </div>
      
      <!-- Contenu principal : les fiches -->
      <div class="main-content">
        <button id="export-button" class="export-button">Exporter les résultats</button>
        <div id="results-stats"></div>
        <div id="fiches-container"></div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function() {
      let allData = [];
      let selectedDepartments = [];
      let isDarkMode = false;

      // Permet d'ouvrir/fermer chaque bloc de filtre indépendamment
      document.querySelectorAll('.filter-header').forEach(header => {
        header.addEventListener('click', () => {
          const target = document.getElementById(header.getAttribute('data-target'));
          target.style.display = (target.style.display === "block") ? "none" : "block";
        });
      });
      
      // Bouton de mode sombre
      const darkModeToggle = document.getElementById('dark-mode-toggle');
      darkModeToggle.addEventListener('click', toggleDarkMode);
      
      // Fonction pour basculer le mode sombre
      function toggleDarkMode() {
        isDarkMode = !isDarkMode;
        document.body.classList.toggle('dark-mode', isDarkMode);
        darkModeToggle.innerHTML = isDarkMode ? '☀️' : '🌙';
        
        // Sauvegarder la préférence de l'utilisateur
        localStorage.setItem('darkModePreference', isDarkMode ? 'dark' : 'light');
      }
      
      // Vérifier la préférence sauvegardée pour le mode sombre
      if (localStorage.getItem('darkModePreference') === 'dark') {
        toggleDarkMode();
      }
      
      // Bouton d'export
      const exportButton = document.getElementById('export-button');
      exportButton.addEventListener('click', exportResults);

      // Initialiser les événements de la carte
      initRegionMap();
      
      // Fonction pour initialiser la carte des régions
      function initRegionMap() {
        document.querySelectorAll('#france-map path').forEach(path => {
          path.addEventListener('click', () => {
            const regionCode = path.getAttribute('data-code');
            const regionName = path.getAttribute('data-name');
            
            if (selectedDepartments.includes(regionCode)) {
              // Désélectionner la région
              selectedDepartments = selectedDepartments.filter(d => d !== regionCode);
              path.classList.remove('selected');
            } else {
              // Sélectionner la région
              selectedDepartments.push(regionCode);
              path.classList.add('selected');
            }
            
            updateSelectedDepartmentsList();
            updateDisplay();
          });
          
          // Ajouter un tooltip au survol
          path.setAttribute('title', path.getAttribute('data-name'));
        });
      }
      
      // Mettre à jour l'affichage des régions sélectionnées
      function updateSelectedDepartmentsList() {
        const list = document.getElementById('selected-dept-list');
        if (selectedDepartments.length === 0) {
          list.textContent = 'Aucune';
        } else {
          const names = selectedDepartments.map(code => {
            const path = document.querySelector(`#france-map path[data-code="${code}"]`);
            return path ? path.getAttribute('data-name') : code;
          });
          list.textContent = names.join(', ');
        }
      }

      // Fonction pour la recherche textuelle
      function searchFilter(searchText) {
        if (!searchText) return () => true;
        
        const searchLower = searchText.toLowerCase();
        return function(item) {
          return (
            (item.bf_titre && item.bf_titre.toLowerCase().includes(searchLower)) || 
            (item.bf_descriptiongenerale && item.bf_descriptiongenerale.toLowerCase().includes(searchLower))
          );
        };
      }
      
      // Fonction pour trier les résultats
      function sortItems(items, sortBy) {
        if (sortBy === 'alpha') {
          return [...items].sort((a, b) => a.bf_titre.localeCompare(b.bf_titre));
        } else if (sortBy === 'year') {
          return [...items].sort((a, b) => {
            const yearA = parseInt(a.listeListeAnneeDeMiseEnLigne) || 0;
            const yearB = parseInt(b.listeListeAnneeDeMiseEnLigne) || 0;
            return yearB - yearA; // Plus récent d'abord
          });
        }
        return items;
      }
      
      // Fonction d'exportation des résultats
      function exportResults() {
        // Récupérer les items filtrés
        const filteredItems = getFilteredItems();
        
        if (filteredItems.length === 0) {
          alert('Aucun résultat à exporter.');
          return;
        }
        
        // Préparer les données pour l'export
        const csvData = filteredItems.map(item => {
          return {
            'Nom': item.bf_titre || '',
            'Type': getPlatformType(item.listeListeTypeplateforme) || '',
            'Description': (item.bf_descriptiongenerale || '').replace(/"/g, '""'), // Échapper les guillemets
            'Année': getYearFromNumber(item.listeListeAnneeDeMiseEnLigne) || '',
            'URL': item.bf_urloutil || '',
            'Type de clients': getClientTypes(item.checkboxListeTypeclientid_typeclient) || '',
            'Coût': getCostType(item.checkboxListeCoutplateformeid_coutplateforme) || ''
          };
        });
        
        // Convertir en CSV
        const headers = Object.keys(csvData[0]);
        const csvContent = [
          headers.join(','),
          ...csvData.map(row => headers.map(header => `"${row[header]}"`).join(','))
        ].join('\n');
        
        // Créer un lien de téléchargement
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.setAttribute('href', url);
        const date = new Date().toISOString().split('T')[0];
        link.setAttribute('download', `outils-agriculture-export-${date}.csv`);
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
      
      // Fonction pour obtenir les items filtrés actuels
      function getFilteredItems() {
        // Récupération des critères sélectionnés pour chaque filtre
        const selectedPlatforms = Array.from(document.querySelectorAll('.filter-platform:checked')).map(cb => cb.value);
        const selectedClients = Array.from(document.querySelectorAll('.filter-client:checked')).map(cb => cb.value);
        const selectedCouts = Array.from(document.querySelectorAll('.filter-cout:checked')).map(cb => cb.value);
        const searchText = document.querySelector('#search-input').value.trim().toLowerCase();
        const sortBy = Array.from(document.querySelectorAll('.filter-sort')).find(rb => rb.checked)?.value || 'alpha';
        
        // Appliquer tous les filtres
        let filteredItems = allData.filter(item => {
          // Filtre par type de plateforme
          const matchesPlatform = selectedPlatforms.length === 0 || selectedPlatforms.includes(item.listeListeTypeplateforme);
          
          // Filtre par type de client
          const itemClients = (item.checkboxListeTypeclientid_typeclient || '').split(',').map(s => s.trim());
          const matchesClient = selectedClients.length === 0 || 
                              itemClients.some(client => selectedClients.includes(client));
          
          // Filtre par coût
          const matchesCout = selectedCouts.length === 0 || 
                            selectedCouts.includes(item.checkboxListeCoutplateformeid_coutplateforme);
          
          // Filtre par région/département (simulé pour l'exemple)
          // Dans un cas réel, vous devriez avoir des données correspondantes dans l'API
          const matchesDepartment = selectedDepartments.length === 0 || 
                                  (item.bf_region && selectedDepartments.includes(item.bf_region));
          
          // Filtre par texte de recherche
          const matchesSearch = searchFilter(searchText)(item);
          
          // Combiner tous les filtres (ET logique)
          return matchesPlatform && matchesClient && matchesCout && matchesDepartment && matchesSearch;
        });
        
        // Trier les résultats
        return sortItems(filteredItems, sortBy);
      }

      // Fonction de mise à jour de l'affichage des fiches
      function updateDisplay() {
        const container = document.getElementById("fiches-container");
        container.innerHTML = '';
        
        // Afficher l'indicateur de chargement
        container.innerHTML = '<div class="loading-container"><div class="loader"></div><p>Chargement des résultats...</p></div>';
        
        // Utiliser setTimeout pour permettre au DOM de se rafraîchir et montrer le loader
        setTimeout(() => {
          // Récupérer les items filtrés et triés
          const filteredItems = getFilteredItems();
          
          // Afficher le nombre de résultats
          updateResultsCount(filteredItems.length);
          
          // Vider le conteneur
          container.innerHTML = '';
          
          if (filteredItems.length === 0) {
            container.innerHTML = `
              <div style="text-align: center; padding: 40px;">
                <h3>Aucun résultat ne correspond à vos critères</h3>
                <p>Essayez de modifier vos filtres ou votre recherche.</p>
              </div>
            `;
            return;
          }
          
          // Calcul du nombre total de groupes de filtres actifs
          const totalActiveFilters = 
            (Array.from(document.querySelectorAll('.filter-platform:checked')).length > 0 ? 1 : 0) +
            (Array.from(document.querySelectorAll('.filter-client:checked')).length > 0 ? 1 : 0) +
            (Array.from(document.querySelectorAll('.filter-cout:checked')).length > 0 ? 1 : 0) +
            (selectedDepartments.length > 0 ? 1 : 0);
          
          // Afficher les fiches filtrées
          filteredItems.forEach(item => renderCard(item, true, totalActiveFilters));
        }, 100); // Délai court pour permettre l'affichage du loader
      }
      
      // Mise à jour du compteur de résultats
      function updateResultsCount(count) {
        const resultsStats = document.getElementById("results-stats");
        resultsStats.innerHTML = `<div>${count} outil${count > 1 ? 's' : ''} trouvé${count > 1 ? 's' : ''}</div>`;
      }

      // Fonctions utilitaires
      function getYearFromNumber(number) {
        const baseYear = 2005;
        return number && !isNaN(number) ? baseYear + (parseInt(number) - 1) : "Non renseigné";
      }
      
      function getPlatformType(type) {
        const types = {
          "1": "Générateur de Boutique",
          "2": "Place de Marché",
          "3": "Outil de gestion"
        };
        return types[type] || "Type inconnu";
      }
      
      function getClientTypes(clientTypes) {
        if (!clientTypes) return "Non renseigné";
        
        const types = {
          "1": "Consommateurs particuliers",
          "2": "Restauration collective",
          "3": "Restauration commerciale",
          "4": "GMS",
          "5": "Commerces de proximité",
          "6": "Grossistes",
          "7": "Transformateurs",
          "8": "Producteurs"
        };
        
        return clientTypes.split(',')
          .map(id => types[id.trim()] || `Type ${id}`)
          .join(', ');
      }
      
      function getCostType(costType) {
        const types = {
          "1": "Totalement gratuit",
          "2": "Commission prélevée au producteur",
          "3": "Abonnement / droit d'entrée pour le producteur",
          "4": "Commission prélevée au consommateur",
          "5": "Abonnement / droit d'entrée pour le consommateur"
        };
        return types[costType] || "Non renseigné";
      }
      
      function getFirstSentence(text) {
        if (!text) return '';
        const match = text.match(/^(.*?)(?:\.\s|$)/);
        return match ? match[1] + '.' : text;
      }
      
      // Fonction pour mettre en surbrillance les termes recherchés
      function highlightText(text, searchTerm) {
        if (!searchTerm || !text) return text;
        
        const searchLower = searchTerm.toLowerCase();
        const textLower = text.toLowerCase();
        const index = textLower.indexOf(searchLower);
        
        if (index === -1) return text;
        
        return text.substring(0, index) + 
               `<span class="highlight-match">${text.substring(index, index + searchTerm.length)}</span>` + 
               text.substring(index + searchTerm.length);
      }

      // Fonction pour créer et afficher une fiche (card)
      function renderCard(item, isMatched, totalActiveFilters) {
        const searchTerm = document.querySelector('#search-input').value.trim();
        
        // Préparer les données de la carte
        const title = item.bf_titre || 'Sans titre';
        const description = item.bf_descriptiongenerale ? getFirstSentence(item.bf_descriptiongenerale) : 'Description non disponible';
        const platformType = getPlatformType(item.listeListeTypeplateforme);
        const anneeCreation = getYearFromNumber(item.listeListeAnneeDeMiseEnLigne);
        const typeClients = getClientTypes(item.checkboxListeTypeclientid_typeclient);
        const ficheUrl = `https://www.oad-venteenligne.org/?${item.id_fiche}`;
        const imageUrl = item.imagebf_image 
                        ? `https://www.oad-venteenligne.org/cache/vignette_${item.imagebf_image}` 
                        : 'https://via.placeholder.com/100?text=Logo';
        
        // Mettre en surbrillance les termes recherchés
        const highlightedTitle = highlightText(title, searchTerm);
        const highlightedDescription = highlightText(description, searchTerm);
        
        // Calculer les filtres correspondants
        let matchedCount = 0;
        const selectedPlatforms = Array.from(document.querySelectorAll('.filter-platform:checked')).map(cb => cb.value);
        const selectedClients = Array.from(document.querySelectorAll('.filter-client:checked')).map(cb => cb.value);
        const selectedCouts = Array.from(document.querySelectorAll('.filter-cout:checked')).map(cb => cb.value);
        
        if (selectedPlatforms.length > 0 && selectedPlatforms.includes(item.listeListeTypeplateforme)) {
          matchedCount++;
        }
        
        if (selectedClients.length > 0) {
          const itemClients = (item.checkboxListeTypeclientid_typeclient || '').split(',').map(s => s.trim());
          if (itemClients.some(client => selectedClients.includes(client))) {
            matchedCount++;
          }
        }
        
        if (selectedCouts.length > 0 && selectedCouts.includes(item.checkboxListeCoutplateformeid_coutplateforme)) {
          matchedCount++;
        }
        
        if (selectedDepartments.length > 0 && item.bf_region && selectedDepartments.includes(item.bf_region)) {
          matchedCount++;
        }
        
        // Créer la carte
        const card = document.createElement("div");
        card.className = isMatched ? "tool-card" : "tool-card unmatched";
        card.innerHTML = `
          <div class="card-left">
            <img src="${imageUrl}" alt="${title}" class="tool-logo">
            <div class="tool-category">${platformType}</div>
            ${totalActiveFilters > 0 
              ? `<div class="match-info">${matchedCount} / ${totalActiveFilters}</div>`
              : ''
            }
          </div>
          <div class="card-right">
            <h2 class="tool-title">${highlightedTitle}</h2>
            <p class="tool-description">${highlightedDescription}</p>
            <div class="highlight-box">
              <p><strong>Année de création :</strong> ${anneeCreation}</p>
              <p><strong>Type d'acheteurs :</strong> ${typeClients}</p>
              ${item.bf_urloutil 
                ? `<p><strong>Adresse web :</strong> <a href="${item.bf_urloutil}" target="_blank" rel="noopener">${item.bf_urloutil}</a></p>` 
                : ''
              }
            </div>
            <button class="cta-button" onclick="window.open('${ficheUrl}', '_blank')">En savoir plus</button>
          </div>
        `;
        
        const container = document.getElementById("fiches-container");
        container.appendChild(card);
      }

      // Chargement des données depuis l'API avec mise en cache
      function loadData() {
        // Vérifier si des données en cache existent
        const cachedData = localStorage.getItem('toolsDataCache');
        const cacheTimestamp = parseInt(localStorage.getItem('toolsDataTimestamp') || '0');
        const now = Date.now();
        const oneDayInMs = 24 * 60 * 60 * 1000;
        
        // Afficher l'indicateur de chargement
        const container = document.getElementById("fiches-container");
        container.innerHTML = '<div class="loading-container"><div class="loader"></div><p>Chargement des données...</p></div>';
        
        // Si le cache est valide (moins d'un jour)
        if (cachedData && (now - cacheTimestamp) < oneDayInMs) {
          try {
            allData = JSON.parse(cachedData);
            updateDisplay();
            return;
          } catch (e) {
            console.error("Erreur lors de la lecture du cache:", e);
            // Si erreur, continuer et charger depuis l'API
          }
        }
        
        // Charger depuis l'API
        fetch("https://www.oad-venteenligne.org/?api/forms/7/entries")
          .then(response => {
            if (!response.ok) {
              throw new Error(`Erreur réseau: ${response.status}`);
            }
            return response.json();
          })
          .then(data => {
            allData = Object.values(data);
            
            // Mettre en cache
            try {
              localStorage.setItem('toolsDataCache', JSON.stringify(allData));
              localStorage.setItem('toolsDataTimestamp', now.toString());
            } catch (e) {
              console.warn("Impossible de mettre en cache les données:", e);
            }
            
            updateDisplay();
          })
          .catch(error => {
            console.error("Erreur lors du chargement des données:", error);
            
            container.innerHTML = `
              <div style="text-align: center; padding: 40px;">
                <h3>Erreur de connexion</h3>
                <p>Impossible de charger les données. Veuillez vérifier votre connexion et réessayer.</p>
                <button onclick="loadData()" class="cta-button" style="margin: 20px auto;">Réessayer</button>
              </div>
            `;
          });
      }

      // Écoute des changements sur les filtres
      document.querySelectorAll('.filter-platform, .filter-client, .filter-cout, .filter-sort').forEach(cb => {
        cb.addEventListener('change', updateDisplay);
      });
      
      // Écoute des changements dans la barre de recherche (avec debounce)
      let searchTimeout;
      document.querySelector('#search-input').addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(updateDisplay, 300); // Attendre 300ms après la fin de la saisie
      });
      
      // Exposer loadData au contexte global pour le bouton de réessai
      window.loadData = loadData;
      
      // Charger les données au démarrage
      loadData();
    });
  </script>
</body>
</html>
